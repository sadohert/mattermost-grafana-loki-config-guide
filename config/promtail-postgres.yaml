# Promtail scrape job for PostgreSQL logs (optional)
# Add this job to your existing promtail-config.yaml on the database server.
#
# Before using this config, replace the following placeholders:
#
#   <LOKI_HOST>   — IP or hostname of the server where Loki is running.
#                   This is your Grafana/Prometheus monitoring server.
#                   Example: 10.0.1.50  or  monitoring.internal
#                   Use "localhost" only if Loki runs on this same machine.
#
#   <PG_HOSTNAME> — This PostgreSQL server's hostname (e.g., mm-db-01).
#                   Used as a label so you can filter logs per server in Grafana.
#
# PostgreSQL log location varies by installation method:
#   Amazon RDS:      Logs are accessed via CloudWatch, not files (this config does not apply)
#   Ubuntu/Debian:   /var/log/postgresql/postgresql-<version>-main.log
#   RHEL/Amazon Linux: /var/lib/pgsql/<version>/data/log/*.log
#
# Ensure the promtail user has read access to the log directory.
# Ensure log_destination = 'stderr' or 'csvlog' in postgresql.conf
# and that logging_collector = on.

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /opt/promtail/positions-postgres.yaml

clients:
  - url: http://<LOKI_HOST>:3100/loki/api/v1/push

scrape_configs:
  # -----------------------------------------------------------------
  # PostgreSQL logs
  # -----------------------------------------------------------------
  - job_name: postgres
    static_configs:
      - targets:
          - localhost
        labels:
          service_name: postgres
          job: postgres
          instance: "<PG_HOSTNAME>"
          # Adjust the path below to match your PostgreSQL installation.
          # The example uses the default Amazon Linux / RHEL path for PostgreSQL 15.
          __path__: /var/lib/pgsql/15/data/log/*.log

    pipeline_stages:
      - multiline:
          firstline: '^\d{4}-\d{2}-\d{2}'
          max_wait_time: 3s
      - regex:
          expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3} \w+) \[(?P<pid>\d+)\] (?P<level>\w+):\s+(?P<message>.*)'
      - labels:
          level:
      - timestamp:
          source: timestamp
          format: "2006-01-02 15:04:05.000 MST"
